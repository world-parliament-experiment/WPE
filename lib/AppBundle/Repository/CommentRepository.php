<?php

namespace AppBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\NonUniqueResultException;
use Doctrine\ORM\NoResultException;

/**
 * CommentRepository
 *
 * This class was generated by the PhpStorm "Php Annotations" Plugin. Add your own custom
 * repository methods below.
 */
class CommentRepository extends EntityRepository
{
    /**
     * @param $pattern
     * @param $orderBy
     * @param $orderDir
     * @return mixed
     */
    public function search($pattern, $orderBy, $orderDir)
    {
        $query = $this->createQueryBuilder('c')
            ->select(['c'])
            ->join("c.initiative",'i')
            ->join("c.createdBy",'u')
            ->join("i.category",'ca')
            ->orderBy($orderBy, $orderDir)
        ;
        if($pattern != ''){
            $query
                ->andWhere("(LOWER(c.message) LIKE :query OR LOWER(i.title) LIKE :query OR LOWER(u.username) LIKE :query OR LOWER(ca.name) LIKE :query)")
                ->setParameters([
                    'query' => '%'.strtolower($pattern).'%',
                ]);
        }
        return $query
            ->getQuery()
            ->execute();
    }

    /**
     * @return mixed
     * @throws NoResultException
     * @throws NonUniqueResultException
     */
    public function countAllComments()
    {
        return $this->createQueryBuilder("c")
            ->select('count(c.id)')
            ->getQuery()
            ->getSingleScalarResult();
    }


}
